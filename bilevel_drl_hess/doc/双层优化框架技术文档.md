# 基于深度强化学习的离网电氢综合能源系统容量规划与运行协同优化

## 摘要

本文提出一种基于深度强化学习（DRL）与混合整数线性规划（MILP）的双层优化框架，用于离网电氢综合能源系统（HESS）的容量规划与运行协同优化。上层采用近端策略优化（PPO）算法进行容量配置决策，下层采用CPLEX求解器求解MILP运行调度问题。该框架通过离线训练与在线部署的两阶段策略，在保证供电可靠性和可再生能源消纳的约束下，最小化系统年化总成本。

---

## 1 系统架构

### 1.1 离网电氢综合能源系统结构

所研究系统为完全离网运行的电氢综合能源系统，包含以下设备：

| 设备 | 符号 | 决策变量 | 单位 |
|------|------|---------|------|
| 电池储能系统（BESS） | $E_{\mathrm{bat}}$ | 储能容量 | kWh |
| 光伏发电（PV） | $P_{\mathrm{PV}}$ | 装机容量 | kW |
| 风力发电（WT） | $P_{\mathrm{WT}}$ | 装机容量 | kW |
| 碱性电解槽（EL） | $P_{\mathrm{EL}}$ | 额定功率 | kW |
| 高压储氢罐（H2T） | $M_{\mathrm{H2}}$ | 储氢容量 | kg |
| 质子交换膜燃料电池（FC） | $P_{\mathrm{FC}}$ | 额定功率 | kW |

系统容量配置向量定义为：

$$\mathbf{x} = [E_{\mathrm{bat}},\; P_{\mathrm{PV}},\; P_{\mathrm{WT}},\; P_{\mathrm{EL}},\; M_{\mathrm{H2}},\; P_{\mathrm{FC}}]^\top \in \mathbb{R}^6$$

### 1.2 能量流动路径

系统能量流动遵循以下路径：

**电力侧主回路：**
$$P_{\mathrm{PV}}^{\mathrm{gen}}(t) + P_{\mathrm{WT}}^{\mathrm{gen}}(t) + P_{\mathrm{dis}}(t) + P_{\mathrm{FC}}(t) + P_{\mathrm{shed}}(t) = P_{\mathrm{load}}(t) + P_{\mathrm{ch}}(t) + P_{\mathrm{EL}}(t)$$

其中：
- **可再生能源发电**：$P_{\mathrm{PV}}^{\mathrm{gen}}(t) = P_{\mathrm{PV}}^{\mathrm{avail}}(t) - P_{\mathrm{cur,PV}}(t)$，$P_{\mathrm{WT}}^{\mathrm{gen}}(t) = P_{\mathrm{WT}}^{\mathrm{avail}}(t) - P_{\mathrm{cur,WT}}(t)$
- **电池储能**：$P_{\mathrm{ch}}(t)$（充电）和 $P_{\mathrm{dis}}(t)$（放电）互斥
- **电解制氢**：$P_{\mathrm{EL}}(t)$ 消耗电力产生氢气 $\dot{m}_{\mathrm{H2,prod}}(t)$
- **燃料电池发电**：$P_{\mathrm{FC}}(t)$ 消耗氢气 $\dot{m}_{\mathrm{H2,cons}}(t)$ 产生电力

**氢气侧回路：**
$$S_{\mathrm{H2}}(t+1) = S_{\mathrm{H2}}(t) + \eta_{\mathrm{H2,ch}} \cdot \dot{m}_{\mathrm{H2,prod}}(t) - \dot{m}_{\mathrm{H2,cons}}(t)$$

**电-氢耦合关系：**
- 电解槽（Power-to-Hydrogen）：$\dot{m}_{\mathrm{H2,prod}}(t) = \eta_{\mathrm{EL}}(t) \cdot P_{\mathrm{EL}}(t) / \mathrm{LHV}_{\mathrm{H2}}$
- 燃料电池（Hydrogen-to-Power）：$\dot{m}_{\mathrm{H2,cons}}(t) = P_{\mathrm{FC}}(t) / (\eta_{\mathrm{FC}}(t) \cdot \mathrm{LHV}_{\mathrm{H2}})$

其中 $\mathrm{LHV}_{\mathrm{H2}} = 33.33\;\mathrm{kWh/kg}$ 为氢气低位发热值。

**跨季节储氢机制：**

系统采用4个季节典型日（春/夏/秋/冬）表征年度运行特性。储氢系统通过跨季节储能将夏季过剩可再生能源存储为氢气，在冬季通过燃料电池转化为电力，实现长时间尺度的能量平衡。季节间储氢状态衔接关系为：

$$S_{\mathrm{H2}}(1, d) = (1 - \sigma)^{N_d^{\mathrm{prev}}} \cdot \left[ S_{\mathrm{H2}}(1, d{-}1) + N_d^{\mathrm{prev}} \cdot \Delta S_d^{\mathrm{prev}} \right], \quad d = 2,3,4$$

其中 $\sigma = 0.02\%/\mathrm{day}$ 为日泄漏率，$N_d^{\mathrm{prev}}$ 为上一季节天数，$\Delta S_d^{\mathrm{prev}} = S_{\mathrm{H2}}(25, d{-}1) - S_{\mathrm{H2}}(1, d{-}1)$ 为典型日内净变化量。冬季末与春季初的年度闭合约束保证了年度氢储状态的循环一致性。

---

## 2 双层优化数学模型

### 2.1 模型总体结构

$$\begin{aligned}
&\textbf{上层（容量规划）:} \\
&\min_{\mathbf{x}} \quad C_{\mathrm{total}}(\mathbf{x}) = C_{\mathrm{inv}}(\mathbf{x}) + C_{\mathrm{op}}^*(\mathbf{x}) \\
&\text{s.t.} \quad \mathrm{LPSP}(\mathbf{x}) \leq \overline{\mathrm{LPSP}}, \quad \mathrm{LREG}(\mathbf{x}) \leq \overline{\mathrm{LREG}}, \quad \mathbf{x}^{\min} \leq \mathbf{x} \leq \mathbf{x}^{\max} \\[6pt]
&\textbf{下层（运行优化）:} \\
&C_{\mathrm{op}}^*(\mathbf{x}) = \min_{\mathbf{y}} \quad C_{\mathrm{op}}(\mathbf{x}, \mathbf{y}) \\
&\text{s.t.} \quad \text{功率平衡、设备运行、储能动态、启停逻辑等约束}
\end{aligned}$$

其中 $\mathbf{x}$ 为上层容量决策变量（6维），$\mathbf{y}$ 为下层运行调度变量（连续+二进制），$C_{\mathrm{op}}^*(\mathbf{x})$ 表示给定容量 $\mathbf{x}$ 下的最优运行成本，由下层MILP求解器返回。

### 2.2 上层目标函数

**年化总成本：**

$$C_{\mathrm{total}}(\mathbf{x}) = C_{\mathrm{inv}}(\mathbf{x}) + C_{\mathrm{op}}^*(\mathbf{x})$$

**年化投资成本（等额年金法）：**

$$C_{\mathrm{inv}}(\mathbf{x}) = \sum_{k \in \mathcal{K}} \mathrm{CRF}(r_p, n_k) \cdot c_k^{\mathrm{inv}} \cdot x_k$$

其中等额年金回收系数（Capital Recovery Factor）：

$$\mathrm{CRF}(r, n) = \frac{r(1+r)^n}{(1+r)^n - 1}$$

各设备投资参数如下表：

| 设备 $k$ | 单位投资成本 $c_k^{\mathrm{inv}}$ | 投资年限 $n_k$ (年) |
|----------|----------------------------------|---------------------|
| BESS | 1500 元/kWh | 12 |
| PV | 4000 元/kW | 25 |
| WT | 7000 元/kW | 20 |
| EL | 5000 元/kW | 15 |
| H2T | 10000 元/kg | 20 |
| FC | 4500 元/kW | 21 |

贴现率 $r_p = 8\%$。

### 2.3 上层约束条件

**供电可靠性约束（缺电概率）：**

$$\mathrm{LPSP}(\mathbf{x}) = \frac{\sum_{d=1}^{4} N_d \sum_{t=1}^{24} P_{\mathrm{shed}}^*(t,d)}{\sum_{d=1}^{4} N_d \sum_{t=1}^{24} P_{\mathrm{load}}(t,d)} \leq \overline{\mathrm{LPSP}} = 5\%$$

**可再生能源消纳约束（弃电率）：**

$$\mathrm{LREG}(\mathbf{x}) = \frac{\sum_{d=1}^{4} N_d \sum_{t=1}^{24} [P_{\mathrm{cur,PV}}^*(t,d) + P_{\mathrm{cur,WT}}^*(t,d)]}{\sum_{d=1}^{4} N_d \sum_{t=1}^{24} [P_{\mathrm{PV}}^{\mathrm{avail}}(t,d) + P_{\mathrm{WT}}^{\mathrm{avail}}(t,d)]} \leq \overline{\mathrm{LREG}} = 15\%$$

**容量边界约束：**

$$\mathbf{x}^{\min} \leq \mathbf{x} \leq \mathbf{x}^{\max}$$

| 变量 | 下界 $x^{\min}$ | 上界 $x^{\max}$ | 单位 |
|------|-----------------|-----------------|------|
| $E_{\mathrm{bat}}$ | 7000 | 16000 | kWh |
| $P_{\mathrm{PV}}$ | 8000 | 12000 | kW |
| $P_{\mathrm{WT}}$ | 5000 | 12000 | kW |
| $P_{\mathrm{EL}}$ | 3500 | 8000 | kW |
| $M_{\mathrm{H2}}$ | 1000 | 6000 | kg |
| $P_{\mathrm{FC}}$ | 2000 | 8000 | kW |

> **注：** 容量搜索范围基于NSGA-II预优化结果缩减，在可行解范围基础上外扩约15%。

### 2.4 下层目标函数

下层目标函数为年运行成本最小化，采用VoLL（Value of Lost Load）方法将切负荷和弃电经济化处理，消除上下层目标不一致问题：

$$C_{\mathrm{op}}(\mathbf{x}, \mathbf{y}) = \sum_{d=1}^{4} N_d \sum_{t=1}^{24} \left[ C_{\mathrm{OM}}(t,d) + C_{\mathrm{deg}}(t,d) + C_{\mathrm{H2}}(t,d) + C_{\mathrm{shed}}(t,d) + C_{\mathrm{cur}}(t,d) \right] + C_{\mathrm{start}}$$

各成本项定义如下：

**运维成本：**
$$C_{\mathrm{OM}}(t,d) = c_{\mathrm{WT}}^{\mathrm{om}} P_{\mathrm{WT}}^{\mathrm{gen}}(t,d) + c_{\mathrm{PV}}^{\mathrm{om}} P_{\mathrm{PV}}^{\mathrm{gen}}(t,d) + c_{\mathrm{bat}}^{\mathrm{om}} [P_{\mathrm{ch}}(t,d) + P_{\mathrm{dis}}(t,d)] + c_{\mathrm{EL}}^{\mathrm{om}} P_{\mathrm{EL}}(t,d) + c_{\mathrm{FC}}^{\mathrm{om}} P_{\mathrm{FC}}(t,d)$$

**退化成本：**
$$C_{\mathrm{deg}}(t,d) = c_{\mathrm{bat}}^{\mathrm{deg}} \frac{P_{\mathrm{ch}}(t,d) + P_{\mathrm{dis}}(t,d)}{2} + c_{\mathrm{EL}}^{\mathrm{deg}} P_{\mathrm{EL}}(t,d) + c_{\mathrm{FC}}^{\mathrm{deg}} P_{\mathrm{FC}}(t,d)$$

**储氢系统运维与持有成本：**
$$C_{\mathrm{H2}}(t,d) = \frac{c_{\mathrm{H2T}}^{\mathrm{om}}}{24} S_{\mathrm{H2}}(t{+}1,d) + c_{\mathrm{H2}}^{\mathrm{hold}} S_{\mathrm{H2}}(t{+}1,d)$$

**切负荷经济化成本（VoLL方法）：**
$$C_{\mathrm{shed}}(t,d) = \mathrm{VoLL} \cdot P_{\mathrm{shed}}(t,d), \quad \mathrm{VoLL} = 30 \;\text{元/kWh}$$

**弃电机会成本：**
$$C_{\mathrm{cur}}(t,d) = c_{\mathrm{cur}} \cdot [P_{\mathrm{cur,PV}}(t,d) + P_{\mathrm{cur,WT}}(t,d)], \quad c_{\mathrm{cur}} = 0.5 \;\text{元/kWh}$$

**启动成本：**
$$C_{\mathrm{start}} = \sum_{d=1}^{4} N_d \sum_{t=1}^{24} \left[ c_{\mathrm{EL}}^{\mathrm{start}} \cdot u_{\mathrm{EL}}^{\mathrm{start}}(t,d) + c_{\mathrm{FC}}^{\mathrm{start}} \cdot u_{\mathrm{FC}}^{\mathrm{start}}(t,d) \right]$$

其中 $c_{\mathrm{EL}}^{\mathrm{start}} = 25$ 元/次，$c_{\mathrm{FC}}^{\mathrm{start}} = 50$ 元/次。

### 2.5 下层约束条件

#### 2.5.1 离网功率平衡约束

$$P_{\mathrm{PV}}^{\mathrm{gen}}(t,d) + P_{\mathrm{WT}}^{\mathrm{gen}}(t,d) + P_{\mathrm{dis}}(t,d) + P_{\mathrm{FC}}(t,d) + P_{\mathrm{shed}}(t,d) = P_{\mathrm{load}}(t,d) + P_{\mathrm{ch}}(t,d) + P_{\mathrm{EL}}(t,d)$$

$$0 \leq P_{\mathrm{shed}}(t,d) \leq P_{\mathrm{load}}(t,d)$$

$$0 \leq P_{\mathrm{cur,PV}}(t,d) \leq P_{\mathrm{PV}}^{\mathrm{avail}}(t,d), \quad 0 \leq P_{\mathrm{cur,WT}}(t,d) \leq P_{\mathrm{WT}}^{\mathrm{avail}}(t,d)$$

#### 2.5.2 电池储能约束

**充放电互斥与功率限制：**
$$P_{\mathrm{ch}}(t,d) \leq P_{\mathrm{bat}}^{\max} \cdot u_{\mathrm{bat}}(t,d), \quad P_{\mathrm{dis}}(t,d) \leq P_{\mathrm{bat}}^{\max} \cdot [1 - u_{\mathrm{bat}}(t,d)]$$

其中 $P_{\mathrm{bat}}^{\max} = 0.21 \cdot E_{\mathrm{bat}}$（0.21C 倍率），$u_{\mathrm{bat}}(t,d) \in \{0, 1\}$。

**SOC动态约束：**
$$E_{\mathrm{bat}}(t{+}1,d) = E_{\mathrm{bat}}(t,d) + \eta_{\mathrm{ch}} \cdot P_{\mathrm{ch}}(t,d) - P_{\mathrm{dis}}(t,d) / \eta_{\mathrm{dis}}$$

其中 $\eta_{\mathrm{ch}} = \eta_{\mathrm{dis}} = 0.95$。

**SOC边界约束：**
$$0.1 \cdot E_{\mathrm{bat}} \leq E_{\mathrm{bat}}(t,d) \leq 0.9 \cdot E_{\mathrm{bat}}, \quad \forall t \in \{2,\ldots,25\}$$

**日循环闭合约束：**
$$E_{\mathrm{bat}}(25,d) = E_{\mathrm{bat}}(1,d) = 0.5 \cdot E_{\mathrm{bat}}$$

**日充放电平衡约束（柔性）：**
$$0.95 \cdot \sum_{t=1}^{24} P_{\mathrm{dis}}(t,d) / \eta \leq \sum_{t=1}^{24} \eta \cdot P_{\mathrm{ch}}(t,d) \leq 1.05 \cdot \sum_{t=1}^{24} P_{\mathrm{dis}}(t,d) / \eta$$

#### 2.5.3 电解槽约束

**功率范围约束：**
$$P_{\mathrm{EL}}^{\min} \cdot u_{\mathrm{EL}}(t,d) \leq P_{\mathrm{EL}}(t,d) \leq P_{\mathrm{EL}}^{\max} \cdot u_{\mathrm{EL}}(t,d)$$

其中最小负荷率 20%，最大负荷率 100%。

**产氢效率约束（夹逼线性化）：**

电解槽效率随负载率变化，采用上下界夹逼方法进行线性化处理：

$$\eta_{\min} \cdot P_{\mathrm{EL}}(t,d) / \mathrm{LHV} \leq \dot{m}_{\mathrm{H2}}(t,d) \leq \eta_{\max} \cdot P_{\mathrm{EL}}(t,d) / \mathrm{LHV}$$

其中 $\eta_{\min} = 0.55$，$\eta_{\max} = 0.75$，典型效率 $\eta_{\mathrm{typ}} = 0.68$。

运行时效率趋近典型值（Big-M约束）：
$$\dot{m}_{\mathrm{H2}}(t,d) \geq \eta_{\mathrm{typ}} \cdot P_{\mathrm{EL}}(t,d) / \mathrm{LHV} - M \cdot [1 - u_{\mathrm{EL}}(t,d)]$$

$$\dot{m}_{\mathrm{H2}}(t,d) \leq M \cdot u_{\mathrm{EL}}(t,d)$$

**启停逻辑约束（含日循环闭合）：**

$$u_{\mathrm{EL}}(24,d) = u_{\mathrm{EL}}(1,d) \quad \text{（日循环闭合）}$$

$$u_{\mathrm{EL}}^{\mathrm{start}}(1,d) - u_{\mathrm{EL}}^{\mathrm{stop}}(1,d) = u_{\mathrm{EL}}(1,d) - u_{\mathrm{EL}}(24,d) \quad \text{（$t=1$ 闭合启动逻辑）}$$

$$u_{\mathrm{EL}}^{\mathrm{start}}(t,d) - u_{\mathrm{EL}}^{\mathrm{stop}}(t,d) = u_{\mathrm{EL}}(t,d) - u_{\mathrm{EL}}(t{-}1,d), \quad t = 2,\ldots,24$$

$$u_{\mathrm{EL}}^{\mathrm{start}}(t,d) + u_{\mathrm{EL}}^{\mathrm{stop}}(t,d) \leq 1, \quad t = 1,\ldots,24$$

**爬坡约束：**
$$P_{\mathrm{EL}}(t,d) - P_{\mathrm{EL}}(t{-}1,d) \leq R_{\mathrm{EL}}^{\mathrm{up}} \cdot P_{\mathrm{EL}}^{\mathrm{rated}}, \quad P_{\mathrm{EL}}(t{-}1,d) - P_{\mathrm{EL}}(t,d) \leq R_{\mathrm{EL}}^{\mathrm{dn}} \cdot P_{\mathrm{EL}}^{\mathrm{rated}}$$

其中 $R_{\mathrm{EL}}^{\mathrm{up}} = 0.5$，$R_{\mathrm{EL}}^{\mathrm{dn}} = 0.8$（额定功率/h）。

**连续运行约束：**
$$u_{\mathrm{EL}}(t{-}1,d) + u_{\mathrm{EL}}(t{+}1,d) \geq 1.5 \cdot u_{\mathrm{EL}}(t,d) - 1, \quad t = 2,\ldots,23$$

#### 2.5.4 储氢系统约束

**储氢动态约束：**
$$S_{\mathrm{H2}}(t{+}1,d) = S_{\mathrm{H2}}(t,d) + \eta_{\mathrm{H2,ch}} \cdot \dot{m}_{\mathrm{H2,prod}}(t,d) - \dot{m}_{\mathrm{H2,cons}}(t,d)$$

其中 $\eta_{\mathrm{H2,ch}} = 0.95$ 为储氢效率。

**SOC边界约束：**
$$0.05 \cdot M_{\mathrm{H2}} \leq S_{\mathrm{H2}}(t,d) \leq 0.95 \cdot M_{\mathrm{H2}}, \quad \forall t \in \{1,\ldots,25\},\; d \in \{1,\ldots,4\}$$

**最大放氢速率约束：**
$$\dot{m}_{\mathrm{H2,cons}}(t,d) \leq 0.1 \cdot M_{\mathrm{H2}}$$

**跨季节衔接约束：**
$$S_{\mathrm{H2}}(1, d) = (1-\sigma)^{N_{d-1}} \cdot \left[ S_{\mathrm{H2}}(1, d{-}1) + N_{d-1} \cdot (S_{\mathrm{H2}}(25, d{-}1) - S_{\mathrm{H2}}(1, d{-}1)) \right], \quad d = 2,3,4$$

**年度闭合约束：**
$$S_{\mathrm{H2}}^{\mathrm{init}} = (1-\sigma)^{N_4} \cdot \left[ S_{\mathrm{H2}}(1, 4) + N_4 \cdot (S_{\mathrm{H2}}(25, 4) - S_{\mathrm{H2}}(1, 4)) \right]$$

其中 $S_{\mathrm{H2}}^{\mathrm{init}} = 0.5 \cdot M_{\mathrm{H2}}$，$\sigma = 0.0002$/day。

#### 2.5.5 燃料电池约束

**功率范围约束：**
$$P_{\mathrm{FC}}^{\min} \cdot u_{\mathrm{FC}}(t,d) \leq P_{\mathrm{FC}}(t,d) \leq P_{\mathrm{FC}}^{\max} \cdot u_{\mathrm{FC}}(t,d)$$

其中最小负荷率 30%，最大负荷率 100%。

**耗氢效率约束（夹逼线性化）：**
$$P_{\mathrm{FC}}(t,d) / (\eta_{\mathrm{FC}}^{\max} \cdot \mathrm{LHV}) \leq \dot{m}_{\mathrm{H2,cons}}(t,d) \leq P_{\mathrm{FC}}(t,d) / (\eta_{\mathrm{FC}}^{\min} \cdot \mathrm{LHV})$$

$$\dot{m}_{\mathrm{H2,cons}}(t,d) \leq M_{\mathrm{H2}}^{\mathrm{big}} \cdot u_{\mathrm{FC}}(t,d)$$

其中 $\eta_{\mathrm{FC}}^{\max} = 0.50$，$\eta_{\mathrm{FC}}^{\min} = 0.425$（即额定效率的85%）。

**启停逻辑约束：** 与电解槽相同结构，包含日循环闭合。

**爬坡约束：**
$$R_{\mathrm{FC}}^{\mathrm{up}} = 0.8, \quad R_{\mathrm{FC}}^{\mathrm{dn}} = 1.0 \quad \text{（额定功率/h）}$$

---

## 3 深度强化学习建模

### 3.1 马尔可夫决策过程定义

将上层容量规划问题建模为马尔可夫决策过程 $(\mathcal{S}, \mathcal{A}, \mathcal{P}, \mathcal{R}, \gamma)$：

#### 3.1.1 状态空间 $\mathcal{S}$（24维）

$$\mathbf{s}_t = \left[ \underbrace{\mathbf{f}_{\mathrm{scen}}}_{10\text{维}},\; \underbrace{\hat{\mathbf{x}}_t}_{6\text{维}},\; \underbrace{\mathbf{h}_t}_{3\text{维}},\; \underbrace{\tau_t}_{1\text{维}},\; \underbrace{\boldsymbol{\delta}_t}_{4\text{维}} \right]^\top$$

各组成部分：

| 分量 | 维度 | 含义 | 归一化方式 |
|------|------|------|-----------|
| $\mathbf{f}_{\mathrm{scen}}$ | 10 | 场景统计特征（负荷均值/峰值/标准差、净负荷统计、光伏/风电利用率及峰值比） | 各项除以固定参考值 |
| $\hat{\mathbf{x}}_t$ | 6 | 当前容量配置 | $\hat{x}_{t,k} = (x_{t,k} - x_k^{\min}) / (x_k^{\max} - x_k^{\min}) \in [0,1]$ |
| $\mathbf{h}_t$ | 3 | 历史最优信息（$C^{\mathrm{best}} / C_{\mathrm{ref}}$, $\mathrm{LPSP}^{\mathrm{best}} / \mathrm{LPSP}_{\mathrm{ref}}$, $\mathrm{LREG}^{\mathrm{best}} / \mathrm{LREG}_{\mathrm{ref}}$） | 截断至 $[0, 5]$ |
| $\tau_t$ | 1 | 步数进度 $t / T_{\max}$ | $[0, 1]$ |
| $\boldsymbol{\delta}_t$ | 4 | 改进信息（成本变化、LPSP变化、LREG变化、改进率） | 各项除以参考值 |

其中 $C_{\mathrm{ref}} = 2500$ 万元/年，$\mathrm{LPSP}_{\mathrm{ref}} = 0.05$，$\mathrm{LREG}_{\mathrm{ref}} = 0.15$。状态向量最终裁剪至 $[-10, 10]$ 防止数值溢出。

#### 3.1.2 动作空间 $\mathcal{A}$（6维连续）

$$\mathbf{a}_t \in [-1, 1]^6$$

动作映射为容量增量调整：

$$\mathbf{x}_{t+1} = \mathrm{clip}\left( \mathbf{x}_t + \mathbf{a}_t \odot \boldsymbol{\Delta}, \; \mathbf{x}^{\min}, \; \mathbf{x}^{\max} \right)$$

其中 $\boldsymbol{\Delta} = (\mathbf{x}^{\max} - \mathbf{x}^{\min}) \times 0.10$ 为步长向量，$\odot$ 为逐元素乘积。

#### 3.1.3 奖励函数 $\mathcal{R}$

$$r_t = \begin{cases}
-\left( \dfrac{C_{\mathrm{total}}(\mathbf{x}_{t+1})}{10^7} + \lambda_{\mathrm{LPSP}} \cdot [\mathrm{LPSP} - \overline{\mathrm{LPSP}}]_+^2 + \lambda_{\mathrm{LREG}} \cdot [\mathrm{LREG} - \overline{\mathrm{LREG}}]_+^2 \right), & \text{可行} \\[4pt]
-100, & \text{不可行}
\end{cases}$$

其中 $[z]_+ = \max(0, z)$，$\lambda_{\mathrm{LPSP}} = 5000$，$\lambda_{\mathrm{LREG}} = 500$。

奖励函数设计要点：
- **成本项**：年化总成本除以 $10^7$ 归一化，使奖励在 $[-5, 0]$ 量级
- **约束惩罚项**：采用二次barrier函数形式，仅在违反约束时激活，惩罚力度随违反程度非线性增长
- **不可行惩罚**：下层MILP求解失败时施加固定大惩罚 $-100$

#### 3.1.4 状态转移与终止条件

- **状态转移**：确定性转移（给定 $\mathbf{x}_t, \mathbf{a}_t$，$\mathbf{x}_{t+1}$ 唯一确定），随机性来自场景采样
- **终止条件**：达到最大步数 $T_{\max} = 50$，或连续 $K = 15$ 步无改进（early stop）
- **折扣因子**：$\gamma = 0.99$

### 3.2 PPO算法实现

#### 3.2.1 网络架构

**策略网络（Actor）：**
$$\pi_\theta(\mathbf{a} | \mathbf{s}) = \mathcal{N}(\boldsymbol{\mu}_\theta(\mathbf{s}),\; \mathrm{diag}(\boldsymbol{\sigma}^2))$$

- 网络结构：$\mathbf{s} \xrightarrow{\mathrm{FC}(24,256)} \mathrm{ReLU} \xrightarrow{\mathrm{FC}(256,256)} \mathrm{ReLU} \xrightarrow{\mathrm{FC}(256,256)} \mathrm{ReLU} \xrightarrow{\mathrm{FC}(256,6)} \boldsymbol{\mu}$
- 标准差：全局可学习参数 $\log \boldsymbol{\sigma} \in \mathbb{R}^6$，裁剪至 $[-2.0, 0.5]$ 后取指数
- 动作采样：Tanh-Squash，$\tilde{\mathbf{a}} = \tanh(\mathbf{u})$，$\mathbf{u} \sim \mathcal{N}(\boldsymbol{\mu}, \boldsymbol{\sigma}^2)$

**价值网络（Critic）：**
$$V_\phi(\mathbf{s}) \in \mathbb{R}$$

- 网络结构：$\mathbf{s} \xrightarrow{\mathrm{FC}(24,256)} \mathrm{ReLU} \xrightarrow{\mathrm{FC}(256,256)} \mathrm{ReLU} \xrightarrow{\mathrm{FC}(256,256)} \mathrm{ReLU} \xrightarrow{\mathrm{FC}(256,1)} V$

#### 3.2.2 Tanh-Squash策略

为将无界高斯分布映射至有界动作空间 $[-1, 1]^6$，采用Tanh-Squash变换：

$$\mathbf{a} = \tanh(\mathbf{u}), \quad \mathbf{u} \sim \mathcal{N}(\boldsymbol{\mu}_\theta, \boldsymbol{\sigma}^2)$$

对数概率修正（Jacobian校正）：

$$\log \pi(\mathbf{a} | \mathbf{s}) = \sum_{i=1}^{6} \left[ \log \mathcal{N}(u_i | \mu_i, \sigma_i^2) - \log(1 - \tanh^2(u_i) + \epsilon) \right]$$

其中 $\epsilon = 10^{-6}$ 保证数值稳定。

#### 3.2.3 广义优势估计 GAE($\lambda$)

$$\hat{A}_t^{\mathrm{GAE}} = \sum_{l=0}^{T-t-1} (\gamma \lambda)^l \delta_{t+l}, \quad \delta_t = r_t + \gamma V_\phi(\mathbf{s}_{t+1})(1 - d_t) - V_\phi(\mathbf{s}_t)$$

其中 $\gamma = 0.99$，$\lambda = 0.95$，$d_t$ 为终止标志。优势值在更新前进行标准化处理：

$$\hat{A}_t \leftarrow \frac{\hat{A}_t - \mathrm{mean}(\hat{A})}{\mathrm{std}(\hat{A}) + 10^{-8}}$$

#### 3.2.4 策略与价值网络更新

**PPO-Clip策略损失：**

$$L_{\mathrm{actor}} = -\frac{1}{N} \sum_{t} \min\left( \rho_t \hat{A}_t,\; \mathrm{clip}(\rho_t, 1{-}\epsilon, 1{+}\epsilon) \hat{A}_t \right) - c_{\mathrm{ent}} \cdot H[\pi_\theta]$$

其中 $\rho_t = \pi_\theta(\mathbf{a}_t | \mathbf{s}_t) / \pi_{\theta_{\mathrm{old}}}(\mathbf{a}_t | \mathbf{s}_t)$，$\epsilon = 0.2$，$c_{\mathrm{ent}} = 0.01$。

**价值损失：**
$$L_{\mathrm{critic}} = \frac{1}{N} \sum_{t} \left( V_\phi(\mathbf{s}_t) - R_t \right)^2$$

其中 $R_t = \hat{A}_t + V_{\phi_{\mathrm{old}}}(\mathbf{s}_t)$ 为GAE回报。

#### 3.2.5 训练超参数

| 超参数 | 符号 | 值 |
|--------|------|-----|
| 训练回合数 | $N_{\mathrm{ep}}$ | 1500 |
| 每回合最大步数 | $T_{\max}$ | 50 |
| Actor学习率 | $\alpha_\pi$ | $10^{-4}$ |
| Critic学习率 | $\alpha_V$ | $2 \times 10^{-4}$ |
| Actor更新步数 | $K_\pi$ | 10 |
| Critic更新步数 | $K_V$ | 10 |
| Clip范围 | $\epsilon$ | 0.2 |
| GAE $\lambda$ | $\lambda$ | 0.95 |
| 折扣因子 | $\gamma$ | 0.99 |
| 熵正则系数 | $c_{\mathrm{ent}}$ | 0.01 |
| 隐藏层维度 | $d_h$ | 256 |
| 梯度裁剪 | $g_{\max}$ | 0.5 |
| 学习率调度 | — | 余弦退火至 $10^{-6}$ |
| Early stop耐心 | $K$ | 15步 |

---

## 4 上下层交互机制

### 4.1 信息传递

双层优化框架中，上下层通过以下信息流进行交互：

```
┌──────────────────────────────────────────────────────┐
│                    上层：PPO容量规划                     │
│  状态 s_t ──→ Actor π(a|s) ──→ 动作 a_t               │
│                                  ↓                     │
│              容量更新: x_{t+1} = clip(x_t + a_t·Δ)     │
└───────────────────────┬──────────────────────────────┘
                        │ 传递: 容量配置 x + 场景数据
                        ↓
┌──────────────────────────────────────────────────────┐
│                  下层：CPLEX MILP运行优化                │
│  min C_op(x, y)                                       │
│  s.t. 功率平衡、SOC动态、启停逻辑、跨季节氢储…          │
│                                                       │
│  返回: 运行成本 C_op*, 调度结果 y* (含切负荷/弃电量)   │
└───────────────────────┬──────────────────────────────┘
                        │ 返回: C_op*, LPSP, LREG
                        ↓
┌──────────────────────────────────────────────────────┐
│                    上层：奖励计算                        │
│  C_total = C_inv(x) + C_op*                            │
│  r_t = -(C_total/1e7 + λ_LPSP·Δ² + λ_LREG·Δ²)       │
│  更新 best, 存储经验, PPO更新                           │
└──────────────────────────────────────────────────────┘
```

### 4.2 上层→下层

- **传递内容**：容量配置向量 $\mathbf{x} \in \mathbb{R}^6$ 和当前场景数据（负荷、光伏出力百分比、风电出力百分比，均为 $24 \times 4$ 矩阵）
- **传递频次**：每个PPO step调用一次下层MILP求解器
- **容量作为参数**：$\mathbf{x}$ 在下层模型中作为**已知参数**（非决策变量），决定设备功率/储能上下限

### 4.3 下层→上层

- **返回内容**：
  - $C_{\mathrm{op}}^*$：最优年运行成本（标量）
  - 详细调度结果：包含各时段切负荷量 $P_{\mathrm{shed}}^*(t,d)$、弃电量 $P_{\mathrm{cur}}^*(t,d)$、储能SOC轨迹等
- **可靠性指标计算**：上层根据返回的调度结果独立计算 $\mathrm{LPSP}$ 和 $\mathrm{LREG}$
- **不可行处理**：若MILP求解失败（infeasible或超时），返回 $C_{\mathrm{op}} = 10^{12}$，上层施加不可行惩罚

### 4.4 VoLL统一目标设计

传统双层优化中，上下层目标函数可能不一致（例如下层最小化运行成本，但不关心切负荷对上层LPSP的影响）。本文采用VoLL方法将切负荷和弃电纳入下层经济目标函数，使得下层求解器在最小化运行成本的同时自然倾向于减少切负荷和弃电，与上层可靠性目标一致。

---

## 5 场景生成与数据增强

### 5.1 典型日表征

采用4个季节典型日（春91天、夏92天、秋91天、冬91天）表征年度运行特性。每个典型日包含24小时时序数据：
- 负荷曲线 $P_{\mathrm{load}}(t,d)$（kW）
- 光伏出力百分比 $\alpha_{\mathrm{PV}}(t,d) \in [0,1]$
- 风电出力百分比 $\alpha_{\mathrm{WT}}(t,d) \in [0,1]$

实际出力：$P_{\mathrm{PV}}^{\mathrm{avail}}(t,d) = \alpha_{\mathrm{PV}}(t,d) \cdot P_{\mathrm{PV}}$，$P_{\mathrm{WT}}^{\mathrm{avail}}(t,d) = \alpha_{\mathrm{WT}}(t,d) \cdot P_{\mathrm{WT}}$。

### 5.2 数据增强策略

为提高PPO策略的泛化能力，训练过程中对基准场景施加随机扰动：

$$\tilde{P}_{\mathrm{load}}(t,d) = P_{\mathrm{load}}(t,d) \cdot (1 + \xi_{t,d}), \quad \xi_{t,d} \sim \mathcal{U}(-0.10, 0.10)$$

光伏和风电出力百分比同样施加独立的 $\pm 10\%$ 均匀扰动，并裁剪至 $[0, 1]$。每个训练episode采样一个新的扰动场景，使PPO策略在不同运行条件下学习鲁棒的容量规划策略。

---

## 6 训练加速策略

### 6.1 MILP求解精度分层

训练阶段采用宽松的求解参数以加速每次MILP调用：

| 参数 | 训练阶段 | 测试/评估阶段 |
|------|---------|--------------|
| 时间限制 | 30秒 | 300秒 |
| MIPGap | 1% | 0.1% |

### 6.2 搜索空间预缩减

基于NSGA-II多目标预优化的Pareto前沿结果，将DRL搜索空间从原始范围缩减至可行解覆盖区域的约115%，搜索体积缩减至原来的约7.5%。

### 6.3 容量评估缓存

在同一episode内，对容量向量按1%网格量化后缓存MILP求解结果，避免对相近容量配置的重复求解。缓存在每个episode开始时清空（因为场景不同）。

### 6.4 Episode内Early Stop

当连续15步未发现更优可行解时提前终止当前episode，避免无效搜索步的MILP调用开销。

---

## 7 离线训练与在线部署

### 7.1 离线训练阶段

训练流程如下：

1. **初始化**：创建PPO Agent（Actor + Critic网络），初始化容量规划环境
2. **Episode循环**（共1500轮）：
   - 采样随机扰动场景
   - 随机初始化容量配置
   - 执行最多50步容量搜索，每步：PPO选择动作 → 更新容量 → 调用MILP求解 → 计算奖励
   - Episode结束后计算GAE，执行PPO策略和价值网络更新
3. **记录**：全局最优解、训练曲线、模型checkpoint

### 7.2 在线部署阶段

训练完成后，PPO策略网络可在毫秒级时间内给出容量调整方向，配合少量MILP评估即可快速适应新的场景条件。在线部署流程：

1. 加载训练好的Actor网络
2. 输入新场景特征和当前容量配置
3. Actor网络推理输出容量调整方向（$< 1$ ms）
4. 可选：对推荐配置调用MILP进行精确评估验证

---

## 附录：运维成本参数

| 参数 | 符号 | 值 | 单位 |
|------|------|-----|------|
| 风电运维成本 | $c_{\mathrm{WT}}^{\mathrm{om}}$ | 0.0296 | 元/kWh |
| 光伏运维成本 | $c_{\mathrm{PV}}^{\mathrm{om}}$ | 0.0096 | 元/kWh |
| 储能运维成本 | $c_{\mathrm{bat}}^{\mathrm{om}}$ | 0.05 | 元/kWh |
| 储能退化成本 | $c_{\mathrm{bat}}^{\mathrm{deg}}$ | 0.20 | 元/kWh |
| 电解槽运维成本 | $c_{\mathrm{EL}}^{\mathrm{om}}$ | 0.015 | 元/kWh |
| 电解槽退化成本 | $c_{\mathrm{EL}}^{\mathrm{deg}}$ | 0.05 | 元/kWh |
| 燃料电池运维成本 | $c_{\mathrm{FC}}^{\mathrm{om}}$ | 0.020 | 元/kWh |
| 燃料电池退化成本 | $c_{\mathrm{FC}}^{\mathrm{deg}}$ | 0.030 | 元/kWh |
| 储氢罐运维成本 | $c_{\mathrm{H2T}}^{\mathrm{om}}$ | 0.001 | 元/kg/day |
| 氢气储存持有成本 | $c_{\mathrm{H2}}^{\mathrm{hold}}$ | 0.001 | 元/kg/h |
| 电解槽启动成本 | $c_{\mathrm{EL}}^{\mathrm{start}}$ | 25 | 元/次 |
| 燃料电池启动成本 | $c_{\mathrm{FC}}^{\mathrm{start}}$ | 50 | 元/次 |
| 切负荷价值 | VoLL | 30 | 元/kWh |
| 弃电机会成本 | $c_{\mathrm{cur}}$ | 0.5 | 元/kWh |
